// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Employee {
  id         Int        @id @default(autoincrement())
  enNo       String     @unique @db.VarChar(50)
  name       String     @db.VarChar(255)
  mode       Int?       // Employee type/category from punch clock
  
  // Work schedule (HH:mm format suggested, stored as strings for simplicity in this schema)
  workStart1 String?    @default("08:00") @db.VarChar(5)
  workEnd1   String?    @default("12:00") @db.VarChar(5)
  workStart2 String?    @default("13:00") @db.VarChar(5)
  workEnd2       String?    @default("17:48") @db.VarChar(5)
  isTreated      Boolean    @default(false)

  // RH Data (v2.0.0)
  startDate      DateTime?  @db.Date
  regDate        DateTime?  @db.Date
  jobTitle       String?    @db.VarChar(100)
  salary         Decimal?   @db.Decimal(10, 2)
  
  // Detalhes de Endere√ßo (v2.1)
  cep            String?    @db.VarChar(10)
  address        String?    @db.VarChar(255) // Logradouro
  number         String?    @db.VarChar(20)
  neighborhood   String?    @db.VarChar(100)
  city           String?    @db.VarChar(100)
  state          String?    @db.VarChar(2)

  phone          String?    @db.VarChar(20)
  cpf            String?    @unique @db.VarChar(14)
  rg             String?    @db.VarChar(20)
  pis            String?    @db.VarChar(20)
  reservista     String?    @db.VarChar(20)
  titulo         String?    @db.VarChar(20)
  cnh            String?    @db.VarChar(20)
  education      String?    @db.VarChar(100)
  maritalStatus  String?    @db.VarChar(50)

  fatherName     String?    @db.VarChar(255)
  motherName     String?    @db.VarChar(255)
  childrenInfo   Json?      // Stores [{name: string, age: number}]

  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  
  punches        Punch[]
  workdays       Workday[]
  salaryHistory  SalaryHistory[]
  
  @@map("employees")
}

model SalaryHistory {
  id         Int      @id @default(autoincrement())
  employeeId Int
  amount     Decimal  @db.Decimal(10, 2)
  reason     String?  @db.Text
  changeDate DateTime @default(now())
  
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  @@map("salary_history")
}

model Punch {
  id         Int      @id @default(autoincrement())
  employeeId Int
  dateTime   DateTime
  ioMode     Int?     @default(0)
  imported   Boolean  @default(false)
  createdAt  DateTime @default(now())
  
  employee   Employee @relation(fields: [employeeId], references: [id])
  
  @@unique([employeeId, dateTime])
  @@index([employeeId, dateTime])
  @@map("punches")
}

model Workday {
  id           Int       @id @default(autoincrement())
  employeeId   Int
  date         DateTime  @db.Date
  entrada1     DateTime? @db.Time(0)
  saida1       DateTime? @db.Time(0)
  entrada2     DateTime? @db.Time(0)
  saida2       DateTime? @db.Time(0)
  
  // Calculations (in minutes)
  workedMinutes   Int      @default(0)
  expectedMinutes Int      @default(0)
  extraMinutes    Int      @default(0)
  balanceMinutes  Int      @default(0)
  
  status       Status    @default(INCOMPLETE)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  
  employee     Employee     @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  adjustments  Adjustment[]
  abono        Abono?
  
  @@unique([employeeId, date])
  @@index([employeeId, date])
  @@map("workdays")
}

model Adjustment {
  id         Int      @id @default(autoincrement())
  workdayId  Int
  field      String   @db.VarChar(50)
  oldValue   String?  @db.VarChar(255)
  newValue   String?  @db.VarChar(255)
  reason     String?  @db.Text
  createdBy  String?  @db.VarChar(100)
  createdAt  DateTime @default(now())
  
  workday    Workday  @relation(fields: [workdayId], references: [id], onDelete: Cascade)
  
  @@index([workdayId])
  @@map("adjustments")
}

model Holiday {
  id          Int      @id @default(autoincrement())
  date        DateTime @unique @db.Date
  name        String   @db.VarChar(255)
  type        HolidayType
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([date])
  @@map("holidays")
}

model Abono {
  id          Int       @id @default(autoincrement())
  workdayId   Int       @unique
  type        AbonoType
  reason      String    @db.VarChar(255)
  startTime   DateTime? @db.Time(0)
  endTime     DateTime? @db.Time(0)
  minutes     Int       // Minutos abonados
  document    String?   @db.VarChar(255) // Nome do arquivo anexado
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  workday     Workday   @relation(fields: [workdayId], references: [id], onDelete: Cascade)
  
  @@index([workdayId])
  @@map("abonos")
}

enum AbonoType {
  FULL_DAY
  PARTIAL
}

enum HolidayType {
  NATIONAL
  MUNICIPAL
  COMPENSATORY
}

enum Status {
  OK
  INCOMPLETE
  EDITED
}
